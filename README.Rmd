---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "80%"
)
```

# bayeslinear

<!-- badges: start -->
<!-- badges: end -->

<tt>bayeslinear</tt> provides tools to perform a Bayes Linear analysis as well as generalising the solution space to convex subsets. For overview of these methodologies see HERE.

## Installation

<tt>bayeslinear</tt> is currently in development; install the latest version from [GitHub](https://github.com/) with:

``` r
install.packages("devtools")
devtools::install_github("astfalckl/bayeslinear")
```

Also, call in some other packages we need for the README
```{r, warning = FALSE, message = FALSE}
library(bayeslinear)
library(ggplot2)
library(CVXR)
library(dplyr)
library(patchwork)
library(latex2exp)

theme_set(theme_bw())
```

# Standard and Generalised Bayes Linear Analysis

We demonstrate the code by repeating the example given in PAPER.

## Creating Belief Structures

A belief structure is the fundamental unit of information that specifies the geometry of a Bayes linear analysis. We are required to specify $\mathbb{E}(X)$, $\mathbb{E}(D)$, $\mathrm{var}(X)$, $\mathrm{var}(D)$ and $\mathrm{cov}(X,D)$. The methods in <tt>bayeslinear</tt> are based on the creation of a belief structure object through the function <tt>belief_structure()</tt>.

```{r}
nx <- 2
nd <- 2

exp_x <- matrix(c(1, 1))
exp_d <- matrix(c(1, 1))
var_x <- matrix(c(0.54, 0.09, 0.09, 0.54), nrow = nx)
cov_xd <- matrix(c(0.4, -0.1, -.1, -.3), nrow = nx)
var_d <- matrix(c(1, -0.2, -0.2, 1), nrow = nd)

bivariate_bs <- belief_structure(exp_x, exp_d, cov_xd, var_x, var_d)
bivariate_bs
```

## Adjusting Belief Structures

A <tt>belief_structure</tt> object is adjusted by some data <tt>d</tt> via the <tt>adjust</tt> method. An adjusted belief structure <tt>adj_belief_structure</tt> is returned. Note that the initial belief structure is always stored in <tt>prior_bs</tt>.

```{r}
d <- c(3, 6.5)
bivariate_adj_bs <- adjust(bivariate_bs, d)
bivariate_adj_bs
```

## Creating Generalised Belief Structures

We may augment a belief structure with a solution constraint by using the <tt>gen_belief_structure</tt> method. This is similar to above however with the inclusion of a quoted constraint that gets passed to <tt>CVXR</tt>. We demonstrate what some of these constraints look like here, and point towards [here](https://cvxr.rbind.io) for a comprehensive list of examples.

```{r}
bivariate_gbs <- gen_belief_structure(
  exp_x, exp_d, cov_xd, var_x, var_d,
  quote(list(gen_adj_exp >= 0))
)
bivariate_gbs
```

## Adjusting Generalised Belief Structures

This happens with the same <tt>adjust</tt> method as before, but returns the generalised adjusted expectation and variance according to the specified constraint.

```{r}
bivariate_adj_gbs <- adjust(bivariate_gbs, d)
bivariate_adj_gbs
```

## Plotting the results

We recreate Figure 1 from PAPER using the results above. We note that <tt>ggplot</tt> has a habit of being very verbose, and so we have hidden the code from the displayed <tt>README</tt> on GitHub. Please consult the source file for all plotting code used.

```{r, echo = FALSE}
adj_exp_text <- tibble(
  x = bivariate_adj_bs$adj_exp[1, ],
  y = bivariate_adj_bs$adj_exp[2, ],
  text = TeX("${E_d}[X]$", output = "character")
)
cadj_exp_text <- tibble(
  x = bivariate_adj_bs$gen_adj_exp[1, ],
  y = bivariate_adj_bs$gen_adj_exp[2, ],
  text = TeX("${E_d^C}[X]$", output = "character")
)

x_min <- -1.5
x_max <- 3.5
y_min <- -3.5
y_max <- 1.5

x_axis <- matrix(c(x_max, x_min, 0, 0), nrow = 2) %>% as_tibble()
y_axis <- matrix(c(0, 0, y_max, y_min), nrow = 2) %>% as_tibble()

adj_exp_plot <- ggplot() +
  geom_rect(
    aes(xmin = 0, xmax = x_max, ymin = 0, ymax = y_max),
    fill = "#d8d8d8"
  ) +
  geom_vline(aes(xintercept = 0), alpha = 0.5) +
  geom_hline(aes(yintercept = 0), alpha = 0.5) +
  geom_point(
    data = adj_exp_text,
    aes(x = x, y = y)
  ) +
  geom_text(
    data = adj_exp_text,
    aes(x = x - .3, y = y - .4, label = text),
    parse = TRUE
  ) +
  geom_path(
    data = bayeslinear::calc_ellipse(
      1, bivariate_adj_bs$adj_exp, bivariate_adj_bs$adj_var
    ),
    aes(x = x, y = y), alpha = 0.8
  ) +
  geom_path(
    data = bayeslinear::calc_ellipse(
      2, bivariate_adj_bs$adj_exp, bivariate_adj_bs$adj_var
    ),
    aes(x = x, y = y), alpha = 0.2
  ) +
  geom_line(data = x_axis, aes(x = V1, y = V2), size = 1) +
  geom_line(data = y_axis, aes(x = V1, y = V2), size = 1) +
  scale_x_continuous(
    TeX('$X_1$'),
    limits = c(-1.5, 3.5),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    TeX('$X_2$'),
    limits = c(-3.5, 1.5),
    expand = c(0, 0)
  ) +
  coord_fixed() +
  theme(panel.grid.minor = element_blank())

  adj_exp_plot
```